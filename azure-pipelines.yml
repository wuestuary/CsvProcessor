trigger:
  - main

pool:
  vmImage: 'macOS-14'

variables:
  buildConfiguration: 'Release'

steps:
- task: UseDotNet@2
  inputs:
    version: '9.0.x'

- script: |
    dotnet workload install maui
    dotnet workload install maui-maccatalyst
  displayName: 'Install MAUI Workloads'

- script: dotnet restore CsvProcessor.csproj
  displayName: 'Restore'

- script: |
    dotnet publish CsvProcessor.csproj \
      -f net8.0-maccatalyst17.5 \
      -c $(buildConfiguration) \
      -p:EnableCodeSigning=true \
      -p:CodesignKey=- \
      -p:CodesignProvision= \
      -p:EnablePackageSigning=false \
      -p:CreatePackage=true \
      -p:PackageFormat=pkg \
      -p:SelfContained=true \
      -p:PublishTrimmed=true \
      -p:TrimMode=partial \
      -p:OutputPath=./output
  displayName: 'Build macOS App'

- script: |
    # 创建 pkg 安装包
    pkgbuild --component ./output/CsvProcessor.app \
      --install-location /Applications \
      --identifier com.companyname.csvprocessor \
      --version 1.0 \
      ./output/CsvProcessor-1.0.pkg
  displayName: 'Create PKG Installer'

- script: |
    echo "=== 最终输出 ==="
    ls -lh ./output/*.pkg ./output/*.app
    du -sh ./output/CsvProcessor.app
    du -sh ./output/CsvProcessor-1.0.pkg
  displayName: 'Final Check'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: './output'
    artifactName: 'macOS-App'