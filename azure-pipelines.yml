trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
  BUILD_CONFIGURATION: 'Release'
  IOS_P12_BASE64: $(IOS_P12_BASE64)           # Apple Distribution P12 ÁöÑ Base64 ÂÜÖÂÆπ
  P12_PASSWORD: $(P12_PASSWORD)               # P12 ÂØÜÁ†Å
  PROVISIONING_PROFILE_BASE64: $(PROVISIONING_PROFILE_BASE64)  # Provisioning Profile Base64
  PROVISIONING_PROFILE_NAME: 'FM_CLIENTING'  # Âú® Xcode ‰∏≠ÁöÑ profile ÂêçÁß∞

stages:
- stage: Build_iOS
  jobs:
  - job: Build
    steps:

    # 1Ô∏è‚É£ ÂÆâË£Ö .NET 8 SDKÔºàÁ°Æ‰øù MAUI iOS workloadÔºâ
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.0.x'
        includePreviewVersions: true

    - script: |
        echo "‚úÖ Restore workloads"
        dotnet workload restore
      displayName: 'Restore MAUI Workloads'

    # 2Ô∏è‚É£ ÂÆâË£Ö Apple P12 ËØÅ‰π¶
    - task: Bash@3
      displayName: 'Install Apple Certificate'
      inputs:
        targetType: 'inline'
        script: |
          echo "$IOS_P12_BASE64" | base64 --decode > cert.p12
          security create-keychain -p build ios-build.keychain
          security import cert.p12 -k ~/Library/Keychains/ios-build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s ~/Library/Keychains/ios-build.keychain
          security unlock-keychain -p build ~/Library/Keychains/ios-build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/ios-build.keychain

    # 3Ô∏è‚É£ ÂÆâË£Ö Provisioning Profile
    - task: Bash@3
      displayName: 'Install Provisioning Profile'
      inputs:
        targetType: 'inline'
        script: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/$PROVISIONING_PROFILE_NAME.mobileprovision

    # 4Ô∏è‚É£ Build iOS IPA
    - task: Bash@3
      displayName: 'Build iOS IPA'
      inputs:
        targetType: 'inline'
        script: |
          echo "üèó Building iOS app"
          dotnet build CsvProcessor.csproj \
            -c $BUILD_CONFIGURATION \
            -f net8.0-ios \
            /p:Platform=iPhone \
            /p:BuildIpa=true \
            /p:CodesignKey="iPhone Distribution: Forevermark Marketing(Shanghai ) Limited" \
            /p:CodesignProvision="$PROVISIONING_PROFILE_NAME"

          echo "üìÇ List IPA folder"
          ls -R bin

    # 5Ô∏è‚É£ Publish IPA Artifact
    - task: PublishBuildArtifacts@1
      displayName: 'Publish IPA Artifact'
      inputs:
        PathtoPublish: 'bin/**/net8.0-ios/ios-arm64'
        ArtifactName: 'iOS'
        publishLocation: 'Container'
