trigger:
  - main

pool:
  vmImage: 'macos-14'   # ⭐ 比 macos-15 快且稳定

variables:
  - group: AppleSigning
  - name: buildConfiguration
    value: 'Release'

steps:
- task: DownloadSecureFile@1
  name: p12Cert
  inputs:
    secureFile: 'iOS_Distribution.p12'

- task: DownloadSecureFile@1
  name: provProfile
  inputs:
    secureFile: 'CsvProcessor.mobileprovision'

- task: UseDotNet@2
  inputs:
    version: '8.0.x'

- script: |
    dotnet workload restore CsvProcessor.csproj
  displayName: 'Restore MAUI iOS Workloads'

- script: |
    dotnet restore CsvProcessor.csproj
  displayName: 'Restore'

- script: |
    security create-keychain -p "$(KEYCHAIN_PASSWORD)" build.keychain
    security default-keychain -s build.keychain
    security unlock-keychain -p "$(KEYCHAIN_PASSWORD)" build.keychain

    security import "$(p12Cert.secureFilePath)" \
      -P "$(P12_PASSWORD)" \
      -A -t cert -f pkcs12

    security find-identity -v -p codesigning

    mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
    cp "$(provProfile.secureFilePath)" ~/Library/MobileDevice/Provisioning\ Profiles/
  displayName: 'Setup Signing'
  env:
    KEYCHAIN_PASSWORD: $(KEYCHAIN_PASSWORD)
    P12_PASSWORD: $(P12_PASSWORD)

- script: |
    CERT_NAME=$(security find-identity -v -p codesigning \
      | grep "iPhone Distribution" \
      | head -1 \
      | sed 's/.*"\(.*\)".*/\1/')

    echo "使用证书: $CERT_NAME"

    dotnet publish CsvProcessor.csproj \
      -f net8.0-ios \
      -c $(buildConfiguration) \
      -p:RuntimeIdentifier=ios-arm64 \
      -p:CodesignKey="$CERT_NAME" \
      -p:CodesignProvision="FM_CLIENTING" \
      -p:BuildIpa=true \
      -p:MtouchLink=SdkOnly \            # ⭐ 核心优化
      -p:EnableAssemblyILStripping=false \
      -p:IpaPackagePath=$(Build.ArtifactStagingDirectory)/CsvProcessor.ipa
  displayName: 'Build iOS IPA'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'iOS-IPA'
