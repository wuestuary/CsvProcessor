trigger:
  - main

pool:
  vmImage: 'macOS-15'

variables:
  - group: AppleSigning
  - name: buildConfiguration
    value: 'Release'

steps:
- task: DownloadSecureFile@1
  name: p12Cert
  inputs:
    secureFile: 'iOS_Distribution.p12'

- task: DownloadSecureFile@1
  name: provProfile
  inputs:
    secureFile: 'CsvProcessor.mobileprovision'

- task: UseDotNet@2
  inputs:
    version: '8.0.x'

- script: |
    dotnet workload install maui ios
  displayName: 'Install MAUI iOS'

- script: dotnet restore CsvProcessor.csproj
  displayName: 'Restore'

- script: |
    echo "=== 证书文件信息 ==="
    ls -la "$(p12Cert.secureFilePath)"
    file "$(p12Cert.secureFilePath)"
    
    echo "=== 创建钥匙串 ==="
    security create-keychain -p "$(KEYCHAIN_PASSWORD)" build.keychain
    security default-keychain -s build.keychain
    security unlock-keychain -p "$(KEYCHAIN_PASSWORD)" build.keychain
    
    echo "=== 导入证书 ==="
    security import "$(p12Cert.secureFilePath)" -P "$(P12_PASSWORD)" -A -t cert -f pkcs12 || echo "导入失败"
    
    echo "=== 查看钥匙串内容 ==="
    security dump-keychain build.keychain | head -50
    
    echo "=== 查找证书 ==="
    security find-identity -v
    
    mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
    cp "$(provProfile.secureFilePath)" ~/Library/MobileDevice/Provisioning\ Profiles/
  displayName: 'Setup Signing Debug'
  env:
    KEYCHAIN_PASSWORD: $(KEYCHAIN_PASSWORD)
    CERTIFICATE_PASSWORD: $(P12_PASSWORD)

- script: |
    # 先列出证书
    security find-identity -v -p codesigning
    
    # 使用第一个找到的 iPhone Distribution 证书
    CERT_NAME=$(security find-identity -v -p codesigning | grep "iPhone Distribution" | head -1 | sed 's/.*"\(.*\)".*/\1/')
    echo "使用证书: $CERT_NAME"
    
    dotnet publish CsvProcessor.csproj \
      -f net8.0-ios \
      -c $(buildConfiguration) \
      -p:RuntimeIdentifier=ios-arm64 \
      -p:CodesignKey="$CERT_NAME" \
      -p:CodesignProvision="FM_CLIENTING" \
      -p:BuildIpa=true \
      -p:IpaPackagePath=$(Build.ArtifactStagingDirectory)/CsvProcessor.ipa
  displayName: 'Build iOS IPA'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'iOS-IPA'