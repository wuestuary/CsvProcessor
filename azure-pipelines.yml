trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
- group: AppleSigning
- name: BUILD_CONFIG
  value: Release
- name: PROJECT
  value: CsvProcessor.csproj
- name: PUBLISH_DIR
  value: $(Build.ArtifactStagingDirectory)/IPA

stages:
- stage: BuildAndPublish
  displayName: Build & Publish iOS IPA
  jobs:
  - job: Build_iOS
    timeoutInMinutes: 120
    displayName: Build iOS IPA
    steps:

    - checkout: self

    - task: UseDotNet@2
      displayName: Use .NET 8 SDK
      inputs:
        packageType: sdk
        version: 8.x
        includePreviewVersions: true

    - task: Bash@3
      displayName: Install MAUI iOS workload
      inputs:
        targetType: inline
        script: |
          dotnet workload install maui ios

    # ✅ 使用内置任务安装证书（推荐）
    - task: InstallAppleCertificate@2
      displayName: 'Install Apple Certificate'
      inputs:
        certSecureFile: 'iOS_Distribution.p12'
        certPwd: '$(P12_PASSWORD)'
        keychain: 'temp'
        # 可选：删除这行如果证书不是从 keychain 导出的
        # keychainPassword: '$(KEYCHAIN_PASSWORD)'

    # ✅ 使用内置任务安装描述文件（推荐）
    - task: InstallAppleProvisioningProfile@1
      displayName: 'Install Provisioning Profile'
      inputs:
        provisioningProfileLocation: 'secureFiles'
        provProfileSecureFile: 'CsvProcessor.mobileprovision'

    # 验证安装（调试用，可选）
    - bash: |
        echo "=== 证书签名身份 ==="
        echo "APPLE_CERTIFICATE_SIGNING_IDENTITY: $(APPLE_CERTIFICATE_SIGNING_IDENTITY)"
        echo "=== 描述文件 UUID ==="
        echo "APPLE_PROV_PROFILE_UUID: $(APPLE_PROV_PROFILE_UUID)"
      displayName: 'Check Signing Identity'

    - task: Bash@3
      displayName: Build iOS App
      inputs:
        targetType: inline
        script: |
          mkdir -p $(PUBLISH_DIR)
          
          # ✅ 关键：使用内置任务提供的变量进行代码签名
          dotnet publish $(PROJECT) \
            -c $(BUILD_CONFIG) \
            -f net8.0-ios \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:ArchiveOnBuild=true \
            -p:CodesignKey="$(APPLE_CERTIFICATE_SIGNING_IDENTITY)" \
            -p:CodesignProvision="$(APPLE_PROV_PROFILE_UUID)" \
            -p:BuildIpa=true \
            -p:IpaPackagePath=$(PUBLISH_DIR)/CsvProcessor.ipa \
            -p:MtouchLink=None \
            -p:EnableAssemblyILStripping=false

    - task: Bash@3
      displayName: Upload to Pgyer
      inputs:
        targetType: inline
        script: |
          curl -F "file=@$(PUBLISH_DIR)/CsvProcessor.ipa" \
               -F "uKey=2c40f4428b862d8d9e9f3bd850cf9c0e" \
               -F "_api_key=6878f12ca703e5fb0919dc41468e8d70" \
               -F "installType=2" \
               -F "updateDescription=Azure DevOps Build $(Build.BuildId)" \
               https://www.pgyer.com/apiv2/app/upload 

    - task: PublishBuildArtifacts@1
      displayName: Publish IPA Artifact
      inputs:
        PathtoPublish: $(PUBLISH_DIR)
        ArtifactName: iOS_IPA
        publishLocation: Container