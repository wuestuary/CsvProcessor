trigger:
- main

pool:
  vmImage: 'macos-14'

variables:
- group: AppleSigning

steps:
- checkout: self

- task: Bash@3
  displayName: Show environment
  inputs:
    targetType: inline
    script: |
      dotnet --info
      xcodebuild -version

- task: Bash@3
  displayName: Build iOS IPA
  inputs:
    targetType: inline
    script: |
      dotnet publish CsvProcessor.csproj \
        -c Release \
        -f net8.0-ios \
        -p:RuntimeIdentifier=ios-arm64 \
        -p:BuildIpa=true \
        -p:Platform=iPhone

- task: Bash@3
  displayName: Copy IPA to Publish folder
  inputs:
    targetType: inline
    script: |
      mkdir -p $(Build.ArtifactStagingDirectory)/IPA
      IPA_FILE=$(find . -name "*.ipa" | head -n 1)

      if [ -z "$IPA_FILE" ]; then
        echo "❌ No IPA found"
        exit 1
      fi

      echo "✅ Found IPA: $IPA_FILE"
      cp "$IPA_FILE" $(Build.ArtifactStagingDirectory)/IPA/

- task: PublishBuildArtifacts@1
  displayName: Publish IPA
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)/IPA
    ArtifactName: iOS_IPA
