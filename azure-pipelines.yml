trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
  BUILD_CONFIGURATION: 'Release'

stages:
- stage: Build_iOS
  displayName: 'Build iOS IPA'
  jobs:
  - job: Build
    displayName: 'Build IPA'
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.x'

    - script: |
        echo "‚òëÔ∏è Restore MAUI workloads"
        dotnet workload restore
      displayName: 'Restore MAUI Workloads'

    - script: |
        echo "üì¶ Decode and install Apple Distribution Certificate"
        echo "$IOS_P12_BASE64_SECRET" | base64 --decode > ios_dist.p12

        echo "üîê Create and unlock temporary keychain"
        security create-keychain -p buildpass build.keychain
        security unlock-keychain -p buildpass build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        security list-keychains -s build.keychain

        echo "üìú Import certificate and allow codesign access"
        security import ios_dist.p12 \
          -k build.keychain \
          -P "$P12_PASSWORD_SECRET" \
          -T /usr/bin/codesign \
          -T /usr/bin/security

        echo "üîë Set key partition list for codesign"
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s \
          -k buildpass \
          build.keychain

        echo "üîç Verify identities"
        security find-identity -v -p codesigning build.keychain

        if [ ! -z "$PROVISIONING_PROFILE_BASE64_SECRET" ]; then
          echo "üìÑ Install provisioning profile"
          echo "$PROVISIONING_PROFILE_BASE64_SECRET" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        fi
      displayName: 'Install iOS Certificate & Provisioning Profile'

    - script: |
        echo "üèó Build the iOS app"
        dotnet build CsvProcessor.csproj \
          -c $(BUILD_CONFIGURATION) \
          -f net8.0-ios \
          /p:Platform=iPhone \
          /p:BuildIpa=true \
          /p:CodesignKey="iPhone Distribution: Forevermark Marketing(Shanghai ) Limited" \
          /p:CodesignProvision="FM_CLIENTING"
      displayName: 'Build iOS IPA'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: 'bin/$(BUILD_CONFIGURATION)/net8.0-ios/ios-arm64'
        ArtifactName: 'iOS'
        publishLocation: 'Container'
      displayName: 'Publish IPA Artifact'
