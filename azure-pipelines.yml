trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
- group: AppleSigning
- name: BUILD_CONFIG
  value: Release
- name: PROJECT
  value: CsvProcessor.csproj
- name: PUBLISH_DIR
  value: $(Build.ArtifactStagingDirectory)/IPA

stages:
- stage: BuildAndPublish
  displayName: Build & Publish iOS IPA
  jobs:
  - job: Build_iOS
    displayName: Build iOS IPA
    steps:

    - checkout: self

    - task: UseDotNet@2
      displayName: Use .NET 8 SDK
      inputs:
        packageType: sdk
        version: 8.x
        includePreviewVersions: true

    - task: Bash@3
      displayName: Install MAUI iOS workload
      inputs:
        targetType: inline
        script: |
          dotnet workload install maui ios

    # 下载证书
    - task: DownloadSecureFile@1
      name: p12Cert
      inputs:
        secureFile: 'iOS_Distribution.p12'

    # 下载描述文件
    - task: DownloadSecureFile@1
      name: provProfile
      inputs:
        secureFile: 'CsvProcessor.mobileprovision'

    - task: Bash@3
      displayName: Install Certificate and Profile
      inputs:
        targetType: inline
        script: |
          set -e
          KEYCHAIN_NAME=build.keychain
          
          # 删除旧钥匙串
          security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
          
          # 创建新钥匙串
          security create-keychain -p "$(KEYCHAIN_PASSWORD)" "$KEYCHAIN_NAME"
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$(KEYCHAIN_PASSWORD)" "$KEYCHAIN_NAME"
          
          # 导入证书
          security import "$(p12Cert.secureFilePath)" \
            -k "$KEYCHAIN_NAME" \
            -P "$(P12_PASSWORD)" \
            -A \
            -T /usr/bin/codesign
          
          # 允许访问
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$(KEYCHAIN_PASSWORD)" \
            "$KEYCHAIN_NAME"
          
          # 复制描述文件
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$(provProfile.secureFilePath)" ~/Library/MobileDevice/Provisioning\ Profiles/
          
          # 显示可用证书
          echo "=== 可用证书 ==="
          security find-identity -v -p codesigning "$KEYCHAIN_NAME"
          
          # 提取证书名称
          CERT_NAME=$(security find-identity -v -p codesigning "$KEYCHAIN_NAME" | grep "iPhone Distribution" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "使用证书: $CERT_NAME"
          echo "##vso[task.setvariable variable=CERT_NAME]$CERT_NAME"

        - task: Bash@3
          displayName: Build iOS IPA
          inputs:
            targetType: inline
            script: |
              mkdir -p $(PUBLISH_DIR)
              
              dotnet publish $(PROJECT) \
                -f net8.0-ios \
                -c $(BUILD_CONFIG) \
                -p:RuntimeIdentifier=ios-arm64 \
                -p:CodesignKey="$(CERT_NAME)" \
                -p:CodesignProvision="FM_CLIENTING" \
                -p:BuildIpa=true \
                -p:IpaPackagePath=$(PUBLISH_DIR)/CsvProcessor.ipa \
                -p:PublishTrimmed=true \
                -p:TrimMode=link  # 改为 link 模式

    - task: Bash@3
      displayName: Upload to Pgyer
      inputs:
        targetType: inline
        script: |
          curl -F "file=@$(PUBLISH_DIR)/CsvProcessor.ipa" \
               -F "uKey=2c40f4428b862d8d9e9f3bd850cf9c0e" \
               -F "_api_key=6878f12ca703e5fb0919dc41468e8d70" \
               -F "installType=2" \
               -F "updateDescription=Azure DevOps Build $(Build.BuildId)" \
               https://www.pgyer.com/apiv2/app/upload

    - task: PublishBuildArtifacts@1
      displayName: Publish IPA Artifact
      inputs:
        PathtoPublish: $(PUBLISH_DIR)
        ArtifactName: iOS_IPA
        publishLocation: Container