trigger:
- main

pool:
  vmImage: 'macos-latest'

variables:
- group: AppleSigning
- name: BUILD_CONFIG
  value: Release
- name: PROJECT
  value: CsvProcessor.csproj
- name: PUBLISH_DIR
  value: $(Build.ArtifactStagingDirectory)/IPA

stages:
- stage: BuildAndPublish
  displayName: Build & Publish iOS IPA
  jobs:
  - job: Build_iOS
    displayName: Build iOS IPA
    steps:
    - task: UseDotNet@2
      displayName: Use .NET 8 SDK
      inputs:
        packageType: sdk
        version: 8.x
        includePreviewVersions: true

    - task: Bash@3
      displayName: Install MAUI iOS workload
      inputs:
        targetType: 'inline'
        script: |
          echo "Restoring MAUI workloads..."
          dotnet workload restore

    - task: Bash@3
      displayName: Install P12 Certificate
      inputs:
        targetType: 'inline'
        script: |
          echo "Decoding P12 certificate..."
          echo $P12_BASE64 | base64 --decode > /tmp/certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import /tmp/certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

    - task: Bash@3
      displayName: Install Provisioning Profile
      inputs:
        targetType: 'inline'
        script: |
          echo "Decoding provisioning profile..."
          echo $PROVISIONING_PROFILE_BASE64 | base64 --decode > /tmp/profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "Provisioning profile installed."

    - task: Bash@3
      displayName: Build IPA
      inputs:
        targetType: 'inline'
        script: |
          echo "Building iOS IPA..."
          dotnet build $(PROJECT) \
            -c $(BUILD_CONFIG) \
            -f net8.0-ios \
            -p:Platform=iPhone \
            -p:BuildIpa=true

    - task: Bash@3
      displayName: Copy IPA to Publish folder
      inputs:
        targetType: 'inline'
        script: |
          echo "Searching for IPA file..."
          mkdir -p $(PUBLISH_DIR)
          IPA_FILE=$(find ./bin/$(BUILD_CONFIG)/net8.0-ios -name "*.ipa" | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "‚ùå No IPA file found!"
            exit 1
          fi
          echo "IPA found: $IPA_FILE"
          cp "$IPA_FILE" $(PUBLISH_DIR)/

    - task: PublishBuildArtifacts@1
      displayName: Publish IPA Artifact
      inputs:
        PathtoPublish: $(PUBLISH_DIR)
        ArtifactName: iOS_IPA
        publishLocation: Container
