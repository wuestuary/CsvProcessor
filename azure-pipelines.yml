trigger:
- main

pool:
  vmImage: macos-14   # üî¥ ÂÖ≥ÈîÆÔºöÂøÖÈ°ª macos-14 ÊâçÊúâ Xcode 16

variables:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'CsvProcessor.csproj'
  CONFIGURATION: 'Release'
  RUNTIME_IDENTIFIER: 'ios-arm64'
  CODESIGN_KEY: 'iPhone Distribution: Forevermark  Marketing(Shanghai ) Limited'
  PROVISIONING_PROFILE_NAME: 'FM_CLIENTING'

steps:
# -----------------------------
# 1Ô∏è‚É£ ÈÄâÊã© Xcode 16
# -----------------------------
- task: Bash@3
  displayName: 'Select Xcode 16'
  inputs:
    targetType: inline
    script: |
      sudo xcode-select -s /Applications/Xcode_16.app
      xcodebuild -version

# -----------------------------
# 2Ô∏è‚É£ ÂÆâË£Ö .NET 8 SDK
# -----------------------------
- task: UseDotNet@2
  displayName: 'Install .NET SDK'
  inputs:
    packageType: 'sdk'
    version: '$(DOTNET_VERSION)'

# -----------------------------
# 3Ô∏è‚É£ ÂÆâË£Ö MAUI Workload
# -----------------------------
- task: Bash@3
  displayName: 'Install MAUI workloads'
  inputs:
    targetType: inline
    script: |
      dotnet workload install maui ios --ignore-failed-sources

# -----------------------------
# 4Ô∏è‚É£ ÂØºÂÖ• Apple ËØÅ‰π¶
# -----------------------------
- task: Bash@3
  displayName: 'Install Apple Distribution Certificate'
  inputs:
    targetType: inline
    script: |
      echo "üì¶ Decode P12"
      echo "$IOS_P12_BASE64" | base64 --decode > ios_dist.p12

      echo "üîê Create keychain"
      security create-keychain -p buildpass build.keychain
      security list-keychains -s build.keychain
      security default-keychain -s build.keychain
      security unlock-keychain -p buildpass build.keychain
      security set-keychain-settings -t 3600 -u build.keychain

      echo "üìú Import certificate"
      security import ios_dist.p12 \
        -k build.keychain \
        -P "$P12_PASSWORD" \
        -T /usr/bin/codesign \
        -T /usr/bin/security

      echo "üîë Set key partition list"
      security set-key-partition-list \
        -S apple-tool:,apple:,codesign: \
        -s \
        -k buildpass \
        build.keychain

      echo "üîç Verify identities"
      security find-identity -v -p codesigning build.keychain


# -----------------------------
# 5Ô∏è‚É£ ÂÆâË£Ö Provisioning Profile
# -----------------------------
- task: Bash@3
  displayName: 'Install Provisioning Profile'
  inputs:
    targetType: inline
    script: |
      mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
      echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/FM_CLIENTING.mobileprovision

# -----------------------------
# 6Ô∏è‚É£ Restore
# -----------------------------
- task: Bash@3
  displayName: 'dotnet restore'
  inputs:
    targetType: inline
    script: |
      dotnet restore $(PROJECT_PATH)

# -----------------------------
# 7Ô∏è‚É£ Build iOS IPAÔºàÊ†∏ÂøÉÔºâ
# -----------------------------
- task: Bash@3
  displayName: 'Build iOS IPA'
  inputs:
    targetType: inline
    script: |
      dotnet publish $(PROJECT_PATH) \
        -f net8.0-ios \
        -c $(CONFIGURATION) \
        -r $(RUNTIME_IDENTIFIER) \
        /p:BuildIpa=true \
        /p:CodesignKey="$(CODESIGN_KEY)" \
        /p:CodesignProvision="$(PROVISIONING_PROFILE_NAME)" \
        /p:MtouchLink=SdkOnly \
        /p:PublishTrimmed=true

# -----------------------------
# 8Ô∏è‚É£ ÂØºÂá∫ IPA
# -----------------------------
- task: CopyFiles@2
  displayName: 'Collect IPA'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: '**/*.ipa'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish IPA'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'ios-ipa'
